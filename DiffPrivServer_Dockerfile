FROM python:2.7

# Copy needed files
COPY ./differential-privacy-master/differential_privacy /diffpriv/differential-privacy-master/differential_privacy
COPY ./differential-privacy-master/BUILD /diffpriv/differential-privacy-master
COPY ./differential-privacy-master/CONTRIBUTING.md /diffpriv/differential-privacy-master
COPY ./differential-privacy-master/differential_privacy_deps.bzl /diffpriv/differential-privacy-master
COPY ./differential-privacy-master/LICENSE /diffpriv/differential-privacy-master
COPY ./differential-privacy-master/README.md /diffpriv/differential-privacy-master
COPY ./differential-privacy-master/WORKSPACE /diffpriv/differential-privacy-master
COPY ./web /diffpriv/web
COPY ./bazel-1.0.1-installer-linux-x86_64.sh /diffpriv
COPY ./Const.py /diffpriv
COPY ./CSVHandler.py /diffpriv
COPY ./DiffPrivServer.py /diffpriv
COPY ./FuncUtils.py /diffpriv
COPY ./QueryHandler.py /diffpriv
COPY ./README.txt /diffpriv
COPY ./requirements.txt /diffpriv

# Change diretory
WORKDIR /diffpriv

RUN mkdir /diffpriv/csv_files/
RUN mkdir /diffpriv/logs/
RUN mkdir /diffpriv/users/

# Install necessary programs
RUN apt-get update && apt-get upgrade -y
RUN apt-get install -y pkg-config zip g++ zlib1g-dev unzip python3 git flex bison libreadline-dev

# Install all python dependencies
RUN pip install -r requirements.txt

# Install bazel
RUN chmod +x bazel-1.0.1-installer-linux-x86_64.sh
RUN ./bazel-1.0.1-installer-linux-x86_64.sh --user
ENV PATH="$HOME/bin/:${PATH}"

WORKDIR /diffpriv/differential-privacy-master/

# Build Google bazel project
RUN /root/bin/bazel build differential_privacy/...

WORKDIR /diffpriv
